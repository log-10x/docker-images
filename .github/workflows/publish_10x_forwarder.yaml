name: Publish 10x forwarder container

on:
  workflow_dispatch:
    inputs:
      release_version:
        required: true
        description: '10x version to install'
        type: string
      docker_hub:
        required: true
        description: 'Which docker hub to publish to'
        type: choice
        options:
          - All
          - GHCR
          - DockerHub
      forwarder_type:
        required: true
        description: 'Type of fwd container to build'
        type: choice
        options:
          - Filebeat
          - Filebeat-Debug
          - Fluent-Bit
          - Fluent-Bit-Debug
          - Fluentd
      tenx_dist:
        required: true
        type: choice
        description: Type of artifact
        options:
          - Edge
          - Native

  workflow_call:
    inputs:
      release_version:
        required: true
        type: string
      docker_hub:
        required: true
        type: string
      forwarder_type:
        required: true
        type: string
      tenx_dist:
        required: true
        type: string

jobs:
  prepare:
    name: Checks parameters and sets vars
    runs-on: ubuntu-latest
    outputs:
      image_name: ${{ steps.vars.outputs.image_name }}
      version_tag: ${{ steps.vars.outputs.version_tag }}
      docker_file: ${{ steps.vars.outputs.docker_file }}
      docker_context: ${{ steps.vars.outputs.docker_context }}
      docker_repo: ${{ steps.vars.outputs.docker_repo }}
      dockerhub_repo: ${{ steps.vars.outputs.dockerhub_repo }}
      docker_images: ${{ steps.vars.outputs.docker_images }}
    steps:
      - name: Check parameters
        uses: actions/github-script@v7
        with:
          script: |
            const validHubs = ["GHCR", "DockerHub", "All"];
            if (!validHubs.includes("${{ inputs.docker_hub }}")) {
              core.setFailed("docker_hub must be one of: GHCR, DockerHub, All")
            }

            const validTypes = ["Filebeat", "Filebeat-Debug", "Fluent-Bit", "Fluent-Bit-Debug", "Fluentd"];
            if (!validTypes.includes("${{ inputs.forwarder_type }}")) {
              core.setFailed("Only Filebeat/Filebeat-Debug/Fluent-Bit/Fluent-Bit-Debug/Fluentd forwarders are supported")
            }

            if ("${{ inputs.tenx_dist }}" != "Edge" && "${{ inputs.tenx_dist }}" != "Native") {
              core.setFailed("Only Edge/Native dists are supported")
            }

      - name: Prepare variables
        id: vars
        run: |
          IMAGE_NAME=""
          if [ "${{ inputs.forwarder_type }}" == "Filebeat" ]; then
            IMAGE_NAME="filebeat-10x"
            echo "docker_file=./main/fwd/filebeat/Dockerfile" >> "$GITHUB_OUTPUT"
          elif [ "${{ inputs.forwarder_type }}" == "Filebeat-Debug" ]; then
            IMAGE_NAME="filebeat-10x"
            echo "docker_file=./main/fwd/filebeat/debug/Dockerfile" >> "$GITHUB_OUTPUT"
          elif [ "${{ inputs.forwarder_type }}" == "Fluent-Bit" ]; then
            IMAGE_NAME="fluent-bit-10x"
            echo "docker_file=./main/fwd/fluent-bit/Dockerfile" >> "$GITHUB_OUTPUT"
          elif [ "${{ inputs.forwarder_type }}" == "Fluent-Bit-Debug" ]; then
            IMAGE_NAME="fluent-bit-10x"
            echo "docker_file=./main/fwd/fluent-bit/debug/Dockerfile" >> "$GITHUB_OUTPUT"
          elif [ "${{ inputs.forwarder_type }}" == "Fluentd" ]; then
            IMAGE_NAME="fluentd-10x"
            echo "docker_file=./main/fwd/fluentd/Dockerfile" >> "$GITHUB_OUTPUT"
          fi

          echo "image_name=$IMAGE_NAME" >> "$GITHUB_OUTPUT"
          echo "docker_context=." >> "$GITHUB_OUTPUT"
          echo "docker_repo=${{ vars.GHCR_REPO_NAME }}" >> "$GITHUB_OUTPUT"
          echo "dockerhub_repo=docker.io/${{ vars.DOCKERHUB_REPO_NAME }}" >> "$GITHUB_OUTPUT"

          if [ "${{ inputs.forwarder_type }}" != "Fluent-Bit-Debug" ] && [ "${{ inputs.forwarder_type }}" != "Filebeat-Debug" ]; then
            if [ "${{ inputs.tenx_dist }}" == "Edge" ]; then
              echo "version_tag=${{inputs.release_version}}-jit" >> "$GITHUB_OUTPUT"
            elif [ "${{ inputs.tenx_dist }}" == "Native" ]; then
              echo "version_tag=${{inputs.release_version}}-native" >> "$GITHUB_OUTPUT"
            fi
          else
            if [ "${{ inputs.tenx_dist }}" == "Edge" ]; then
              echo "version_tag=${{inputs.release_version}}-jit-debug" >> "$GITHUB_OUTPUT"
            elif [ "${{ inputs.tenx_dist }}" == "Native" ]; then
              echo "version_tag=${{inputs.release_version}}-native-debug" >> "$GITHUB_OUTPUT"
            fi
          fi

          IMAGES=""
          if [ "${{ inputs.docker_hub }}" == "GHCR" ] || [ "${{ inputs.docker_hub }}" == "All" ]; then
            IMAGES="${{ vars.GHCR_REPO_NAME }}/$IMAGE_NAME"
          fi
          if [ "${{ inputs.docker_hub }}" == "DockerHub" ] || [ "${{ inputs.docker_hub }}" == "All" ]; then
            if [ -n "$IMAGES" ]; then
              IMAGES=$(printf '%s\n%s' "$IMAGES" "docker.io/${{ vars.DOCKERHUB_REPO_NAME }}/$IMAGE_NAME")
            else
              IMAGES="docker.io/${{ vars.DOCKERHUB_REPO_NAME }}/$IMAGE_NAME"
            fi
          fi
          {
            echo 'docker_images<<EOF'
            echo "$IMAGES"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

  publish_x86:
    name: "Build x86 ${{inputs.forwarder_type}} ${{needs.prepare.outputs.version_tag}}"
    runs-on: ubuntu-latest
    timeout-minutes: 12
    needs: prepare

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          path: main

      - name: Login to GHCR
        if: ${{ inputs.docker_hub == 'GHCR' || inputs.docker_hub == 'All' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to Docker Hub
        if: ${{ inputs.docker_hub == 'DockerHub' || inputs.docker_hub == 'All' }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Docker meta
        id: docker-meta
        uses: docker/metadata-action@v5
        with:
          images: ${{needs.prepare.outputs.docker_images}}
          tags: |
            type=raw,value=${{needs.prepare.outputs.version_tag}}-amd64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Publish container
        uses: docker/build-push-action@v6
        with:
          file: ${{needs.prepare.outputs.docker_file}}
          context: ${{needs.prepare.outputs.docker_context}}
          platforms: linux/amd64
          push: true
          provenance: false
          build-args: |
            VERSION=${{inputs.release_version}}
            FLAVOR=${{inputs.tenx_dist}}
          tags: ${{ steps.docker-meta.outputs.tags }}

  publish_aarch64:
    name: "Build aarch64 ${{inputs.forwarder_type}} ${{needs.prepare.outputs.version_tag}}"
    runs-on: linux-arm64-2core
    timeout-minutes: 12
    needs: prepare

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          path: main

      - name: Login to GHCR
        if: ${{ inputs.docker_hub == 'GHCR' || inputs.docker_hub == 'All' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to Docker Hub
        if: ${{ inputs.docker_hub == 'DockerHub' || inputs.docker_hub == 'All' }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Docker meta
        id: docker-meta
        uses: docker/metadata-action@v5
        with:
          images: ${{needs.prepare.outputs.docker_images}}
          tags: |
            type=raw,value=${{needs.prepare.outputs.version_tag}}-aarch64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Publish container
        uses: docker/build-push-action@v6
        with:
          file: ${{needs.prepare.outputs.docker_file}}
          context: ${{needs.prepare.outputs.docker_context}}
          platforms: linux/arm64
          push: true
          provenance: false
          build-args: |
            VERSION=${{inputs.release_version}}
            FLAVOR=${{inputs.tenx_dist}}
          tags: ${{ steps.docker-meta.outputs.tags }}

  publish_manifest:
    name: Publish multiarch manifest for ${{needs.prepare.outputs.version_tag}}
    needs:
      - prepare
      - publish_x86
      - publish_aarch64
    uses: ./.github/workflows/update_multiarch_manifest.yaml
    with:
      version_tag: ${{needs.prepare.outputs.version_tag}}
      docker_hub: ${{ inputs.docker_hub }}
      docker_repo: ${{ needs.prepare.outputs.docker_repo }}
      image_name: ${{ needs.prepare.outputs.image_name }}
      dockerhub_repo: ${{ needs.prepare.outputs.dockerhub_repo }}
    secrets: inherit
